# SoulMate 全局深度优化执行方案 (完整版)

抱歉之前的总结有所遗漏。结合两轮审计，我们共发现了 **6 个关键优化点**。为了确保“一次检查到彻底”，以下是包含所有 6 个点的完整执行方案，按优先级排序。

## 完整优化任务清单

### 第一类：高危风险修复 (必须立即执行)

**1. Release 包崩溃风险修复 (Proguard Rules)**
*   **问题**: `proguard-rules.pro` 缺失 Gson/Retrofit 规则。开启混淆后，网络请求数据模型会被重命名，导致 JSON 解析失败，App 网络功能瘫痪。
*   **执行**: 添加 `-keep class com.soulmate.data.model.** { *; }` 等规则。

**2. 数据库崩溃隐患修复 (Embedding Dimensions)**
*   **问题**: `MockEmbeddingService` (384维) 与 `MemoryEntity` (1024维) 不一致。若服务降级或切换，会导致 ObjectBox 索引构建失败甚至 Native Crash。
*   **执行**: 将 `MockEmbeddingService` 的维度修正为 **1024**。

### 第二类：核心体验与质量提升

**3. LLM 真流式改造 (Real Streaming)**
*   **问题**: 当前为“伪流式”（阻塞等待完整响应后模拟打字），首字延迟极高。
*   **执行**: 改造 `LLMApiService` 为 `@Streaming`，并在 `LLMService` 中实现 SSE 流式解析，实现即时响应。

**4. 移除脏数据源 (Remove Random Embedding)**
*   **问题**: Embedding API 失败时生成随机向量。这会污染数据库，导致 RAG 检索出无关记忆，且脏数据难以清洗。
*   **执行**: 移除 `DoubaoEmbeddingService` 的随机降级逻辑，失败时直接抛出异常，宁缺毋滥。

### 第三类：稳定性与健壮性增强

**5. API 调用重试机制 (Retry Policy)**
*   **问题**: 网络层无重试逻辑，移动端网络波动会导致对话直接失败。
*   **执行**: 在 `LLMService` 和 `EmbeddingService` 中引入指数退避重试（Retry with Exponential Backoff）。

**6. 自动数据清理 (Data Cleanup)**
*   **问题**: 缺乏历史数据清理策略，数据库无限增长将占满用户存储。
*   **执行**: 创建 `CleanupWorker`，定期（如每日）删除超过一定期限（如 90天）的非核心记忆。

---

## 执行计划

我们将分批次执行这 6 个优化点：

1.  **第一批 (安全底座)**: 修复 Proguard 规则、统一 Embedding 维度。（解决崩溃风险）
2.  **第二批 (核心链路)**: 移除随机 Embedding、实现 LLM 真流式、添加重试机制。（提升体验与质量）
3.  **第三批 (运维策略)**: 实现 `CleanupWorker`。（解决长期存储问题）

请确认是否按此完整列表开始执行。