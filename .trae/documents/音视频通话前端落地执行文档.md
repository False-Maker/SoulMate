## 背景结论
- 当前仓库只有“语音输入 ASR + 数字人渲染”，没有真正的实时语音/视频通话前端（无 WebRTC/RTC SDK、无通话页面/路由）。
- 你说“后端已实现”推断是另一个仓库/服务；本执行文档按“后端已提供通话信令与房间 API”来写。

## 选型（先定 1 个，否则无法落地）
- **方案 A（推荐默认）WebRTC 原生**：客户端直接集成 WebRTC（PeerConnection），后端只做信令（offer/answer/candidate）+ 房间管理。
- **方案 B 供应商 RTC（Agora/ZEGO/声网等）**：客户端集成厂商 SDK，后端只做鉴权 Token + 房间分配。
- **信令通道**：
  - 若后端是 Socket.IO：复用现有 `io.socket:socket.io-client`（当前依赖是 Xmov 的必需依赖，项目里可复用）。
  - 若后端是 WebSocket：用 OkHttp WebSocket（项目已依赖 OkHttp）。

本文件清单按 **方案 A + WebSocket/Socket.IO 二选一** 给出；你们后端具体协议确定后删掉不需要的分支即可。

## 需要新增/修改的文件清单（精确到路径）

### 1) 路由与页面（UI）
**修改**
- [Screen.kt](file:///d:/Demo/SoulMate/app/src/main/java/com/soulmate/ui/navigation/Screen.kt)
  - 新增路由：`VoiceCall`、`VideoCall`（可带参数：roomId/peerId/role）。
- [SoulMateApp.kt](file:///d:/Demo/SoulMate/app/src/main/java/com/soulmate/ui/SoulMateApp.kt)
  - 注册 `VoiceCallScreen` / `VideoCallScreen` composable。
- [ChatScreen.kt](file:///d:/Demo/SoulMate/app/src/main/java/com/soulmate/ui/screens/ChatScreen.kt)
  - 增加“发起语音/视频通话”入口按钮（以及来电弹窗入口，如果做被叫）。

**新增（建议目录）**
- `app/src/main/java/com/soulmate/ui/screens/call/VoiceCallScreen.kt`
- `app/src/main/java/com/soulmate/ui/screens/call/VideoCallScreen.kt`
- `app/src/main/java/com/soulmate/ui/screens/call/components/CallTopBar.kt`
- `app/src/main/java/com/soulmate/ui/screens/call/components/CallControls.kt`（静音/免提/挂断/切摄像头）
- `app/src/main/java/com/soulmate/ui/screens/call/components/RemoteVideoView.kt`（AndroidView 包装 SurfaceViewRenderer/TextureView）
- `app/src/main/java/com/soulmate/ui/screens/call/components/LocalPreviewView.kt`

### 2) ViewModel 与状态机
**新增**
- `app/src/main/java/com/soulmate/ui/viewmodel/CallViewModel.kt`
- `app/src/main/java/com/soulmate/ui/state/CallState.kt`（Idle/Outgoing/Ringing/Connecting/InCall/Ended/Error + media 状态）

### 3) 通话领域层（Repository / UseCase）
**新增**
- `app/src/main/java/com/soulmate/data/repository/CallRepository.kt`（接口）
- `app/src/main/java/com/soulmate/data/repository/impl/CallRepositoryImpl.kt`
- `app/src/main/java/com/soulmate/data/model/call/CallModels.kt`（room、participant、signal message 等）

### 4) 信令层（与后端对接）
**二选一**
- WebSocket 分支（推荐通用）：
  - `app/src/main/java/com/soulmate/data/network/call/CallSignalingClient.kt`（OkHttp WebSocket 封装）
  - `app/src/main/java/com/soulmate/data/network/call/CallSignalingProtocol.kt`（序列化/反序列化，事件类型：join/offer/answer/candidate/leave/busy）
- Socket.IO 分支（如果后端用 socket.io）：
  - `app/src/main/java/com/soulmate/data/network/call/CallSocketIoClient.kt`

### 5) WebRTC 媒体引擎层（只在方案 A 需要）
**新增**
- `app/src/main/java/com/soulmate/data/rtc/WebRtcEngine.kt`（封装 PeerConnectionFactory、音视频 track、ICE 配置）
- `app/src/main/java/com/soulmate/data/rtc/WebRtcPeer.kt`（管理本地/远端 peer、sdp/candidate 收发）
- `app/src/main/java/com/soulmate/data/rtc/AudioRouteManager.kt`（扬声器/听筒/蓝牙路由）

### 6) 依赖注入与配置
**修改**
- `app/src/main/java/com/soulmate/di/NetworkModule.kt`
  - 提供通话信令 baseUrl / OkHttp WebSocket client（或 Socket.IO client）。
- `app/src/main/java/com/soulmate/di/AppModule.kt`
  - bind `CallRepository`、`CallSignalingClient`、`WebRtcEngine`。

### 7) 权限与系统能力
**修改**
- [AndroidManifest.xml](file:///d:/Demo/SoulMate/app/src/main/AndroidManifest.xml)
  - 语音：`RECORD_AUDIO`
  - 视频：`CAMERA`
  - 网络：`INTERNET`
  - 可选：`BLUETOOTH_CONNECT`（Android 12+ 蓝牙耳机路由）
  - 可选：前台服务（若做后台保持通话）：`FOREGROUND_SERVICE` + `FOREGROUND_SERVICE_MICROPHONE`/`...CAMERA`

**新增（可选：后台通话保持）**
- `app/src/main/java/com/soulmate/service/CallForegroundService.kt`
- `app/src/main/java/com/soulmate/worker/CallKeepAliveWorker.kt`（如果你们用 WorkManager 做心跳/重连）

### 8) Gradle 依赖（方案 A 必需）
**修改**
- [app/build.gradle.kts](file:///d:/Demo/SoulMate/app/build.gradle.kts)
  - 增加 WebRTC 依赖（具体 artifact 需要你们定：google-webrtc/官方 maven 或私有 AAR）。
  - 若用 JSON 序列化：当前已有 Gson，可复用；也可引入 Kotlinx-serialization（需插件）。

## 执行步骤（按提交粒度）
1) **定协议**：把后端信令事件/字段（join、offer、answer、candidate、leave、busy、timeout）写成 `CallSignalingProtocol` 的数据模型。
2) **加导航与页面壳**：新增 VoiceCall/VideoCall 路由与空页面，打通从 Chat 发起跳转。
3) **实现 CallViewModel 状态机**：Outgoing/Connecting/InCall/Ended，先不接媒体，先把“信令收发与页面状态”跑通。
4) **接入 WebRTC（或厂商 SDK）**：
   - 语音通话：只建音频 track、扬声器切换、静音。
   - 视频通话：增加 Camera capturer、本地预览、远端渲染 view。
5) **异常与重连**：网络断开、对端离开、超时、busy，统一落到 CallState。
6) **权限与后台**：权限弹窗、拒绝处理；可选前台服务保持通话。
7) **验证**：
   - 双端设备互打：语音通话稳定 3 分钟；切前后台不掉线（若要求）；视频帧率/音画同步。
   - 回归：Chat/DigitalHuman/ASR 不受影响。

## 交付物（你拿去安排任务/排期用）
- 以上文件清单对应的 PR/提交分 3～5 个：
  1) 路由+页面壳
  2) 信令层+状态机
  3) WebRTC 音频
  4) WebRTC 视频
  5) 后台/权限/重连（可选）

如果你把“后端已实现”的接口文档（URL、鉴权、WS/Socket.IO 事件 payload 示例）贴出来，我可以把清单里 **信令层文件** 的字段/事件名完全对齐你们服务端规范。